<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>记忆画板 - 无重复生成增强版</title>
<style>
  :root { --blur-val: 8px; }

  body { 
    margin: 0; overflow: hidden; background-color: #e0f2fe; 
    font-family: "Segoe UI", "Microsoft YaHei", sans-serif; height: 100vh; 
    display: flex; justify-content: center; align-items: center;
  }

  /* 初始界面样式 */
  #start-screen {
    position: relative; width: 600px; padding: 30px 40px;
    background-color: white; border-radius: 15px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.15);
    display: flex; align-items: center; justify-content: space-between;
    z-index: 2000000; transition: opacity 0.5s ease, transform 0.5s ease;
  }

  #start-screen.fade-out { opacity: 0; transform: scale(0.95); }
  #start-message { font-size: 28px; color: #4A4A4A; font-weight: 600; }
  #start-button {
    padding: 12px 28px; background-color: #8E44AD; color: white;
    font-size: 18px; border: none; border-radius: 8px; cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s ease;
  }
  #start-button:hover { background-color: #6C3483; transform: translateY(-2px); }

  /* 背景与窗口 */
  #bg-layer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=1600');
    background-size: cover; background-position: center;
    filter: blur(var(--blur-val)); transform: scale(1.1); z-index: -1; opacity: 0.6;
    display: none;
  }

  .window {
    position: absolute; border-radius: 6px; overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1); 
    background-color: white; border: 1px solid rgba(0,0,0,0.05); user-select: none;
    transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.3s;
    backface-visibility: hidden; transform-style: preserve-3d;
    display: none;
  }

  .window.active { display: block; animation: win-pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }

  @keyframes win-pop { 
    0% { transform: scale(0.6); opacity: 0; } 
    100% { transform: scale(1); opacity: 1; } 
  }

  .title-bar {
    background: white; height: 22px; display: flex; align-items: center;
    justify-content: space-between; padding: 0 8px; font-size: 10px; color: #888;
    border-bottom: 1px solid #fcfcfc; cursor: move;
  }

  .content { width: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: zoom-in; }
  .content-img { 
    width: 100%; height: auto; display: block; pointer-events: none; 
    image-rendering: -webkit-optimize-contrast;
  }

  .content-text { 
    width: 147px; height: 80px; display: flex; align-items: center; justify-content: center;
    padding: 10px; color: #555; font-size: 12px; font-weight: 600; text-align: center;
  }

  #zoom-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(0px);
    display: none; z-index: 1999999; cursor: zoom-out;
    opacity: 0; transition: all 0.5s ease;
  }
  #zoom-overlay.active { backdrop-filter: blur(15px); background: rgba(255, 255, 255, 0.3); opacity: 1; }

  .close-btn { cursor: pointer; font-size: 11px; color: #ccc; }
  .close-btn:hover { color: #f44336; }
</style>
</head>
<body>

<div id="start-screen">
  <span id="start-message">点击开启小惊喜</span>
  <button id="start-button">GO!</button>
</div>

<div id="bg-layer"></div>
<div id="zoom-overlay"></div>

<script>
  // --- 图片数据池 ---
  const rawImages = [
    "af2cc7644a88d4ccc46c28d8a76b1ff7.JPG", "IMG_0115.JPG", "IMG_0511.JPG", "IMG_0769.JPG", "IMG_0812.JPG", "IMG_0837.jpeg", "IMG_0837.JPG", "IMG_0856.JPG", "IMG_1597.JPG", "IMG_1703.JPG", "IMG_2151.JPG", "IMG_2476.JPG", "IMG_2803.JPG", "IMG_3900.JPG", "IMG_4480.JPG", "IMG_4591.JPG", "IMG_4742.JPG", "IMG_4749.JPG", "IMG_4882.JPG", "IMG_4978.JPG", "IMG_4985.JPG", "IMG_4997.JPG", "IMG_5019.JPG", "IMG_5029.JPG", "IMG_5611.JPG", "IMG_5616.JPG", "IMG_5663.JPG", "IMG_5696.JPG", "IMG_5730.JPG", "IMG_7107.JPG", "IMG_7166.JPG", "IMG_7385.JPG", "IMG_7468.JPG", "IMG_7781.JPG", "IMG_8562.JPG", "IMG_8616.JPG", "IMG_8675.JPG", "IMG_8684.JPG", "IMG_8704.JPG", "IMG_8743.JPG", "IMG_8752.JPG", "IMG_8761.JPG", "IMG_8869.JPG", "IMG_8875.JPG", "IMG_8896.JPG"
  ];

  // 用于控制不重复生成的队列
  let imageQueue = [];
  let phraseQueue = [];

  const paleColors = ['rgba(214, 85, 150, 0.3)', 'rgba(202, 113, 195, 0.3)', 'rgba(152, 162, 198, 0.3)', 'rgba(202, 188, 175, 0.3)', 'rgba(232, 224, 162, 0.3)'];
  const rawPhrases = ["今天辛苦啦", "记得喝水", "别熬夜", "万事顺遂", "最棒的你", "保持微笑", "生活明朗", "平安喜乐"];
  
  let zIndexCounter = 100;
  let currentZoomed = null;
  const overlay = document.getElementById('zoom-overlay');

  // --- 核心：洗牌算法，确保不重复 ---
  function shuffle(array) {
    let currentIndex = array.length, randomIndex;
    const newArray = [...array];
    while (currentIndex != 0) {
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex--;
      [newArray[currentIndex], newArray[randomIndex]] = [newArray[randomIndex], newArray[currentIndex]];
    }
    return newArray;
  }

  // 获取下一张不重复的图片
  function getNextImage() {
    if (imageQueue.length === 0) {
      imageQueue = shuffle(rawImages); // 如果抽完了，重新洗牌
    }
    return imageQueue.pop(); // 弹出一张
  }

  // 获取下一个不重复的短语
  function getNextPhrase() {
    if (phraseQueue.length === 0) {
      phraseQueue = shuffle(rawPhrases);
    }
    return phraseQueue.pop();
  }

  function createPopup() {
    const win = document.createElement('div');
    win.className = 'window';
    win.style.zIndex = zIndexCounter++;
    win.style.left = Math.floor(Math.random() * (window.innerWidth - 160)) + 'px';
    win.style.top = Math.floor(Math.random() * (window.innerHeight - 160)) + 'px';

    const isImage = Math.random() < 0.85; 
    
    if (isImage) {
      const src = getNextImage(); // 调用不重复获取逻辑
      const img = new Image();
      img.src = src;
      img.className = "content-img";
      img.onload = function() {
        win.style.width = '110px'; 
        win.innerHTML = `<div class="title-bar"><span>Moment</span><div class="title-controls"><span class="close-btn" onclick="this.closest('.window').remove()">✕</span></div></div><div class="content"></div>`;
        win.querySelector('.content').appendChild(img);
        win.ondblclick = (e) => { e.stopPropagation(); toggleZoom(win); };
        bindWindowEvents(win);
        document.body.appendChild(win);
        win.classList.add('active');
      };
      img.onerror = function() { renderText(win); };
    } else {
      renderText(win);
    }
  }

  function renderText(win) {
    const p = getNextPhrase(); // 调用不重复获取逻辑
    const c = paleColors[Math.floor(Math.random() * paleColors.length)];
    win.style.width = '147px';
    win.innerHTML = `<div class="title-bar"><span>提示</span><div class="title-controls"><span class="close-btn" onclick="this.closest('.window').remove()">✕</span></div></div><div class="content" style="background:${c}"><div class="content-text">${p}</div></div>`;
    document.body.appendChild(win);
    bindWindowEvents(win);
    win.classList.add('active');
  }

  // --- 启动逻辑 ---
  document.getElementById('start-button').addEventListener('click', function() {
    document.getElementById('start-screen').classList.add('fade-out');
    setTimeout(() => {
      document.getElementById('start-screen').remove();
      document.body.style.display = 'block';
      document.getElementById('bg-layer').style.display = 'block';
      setTimeout(() => document.getElementById('bg-layer').style.opacity = '1', 10);
      
      setInterval(createPopup, 600); // 稍微放慢生成速度，增加体验感
      setInterval(() => {
        const all = document.querySelectorAll('.window:not(.is-zoomed)');
        if (all.length > 200) all[0].remove(); // 屏幕保留30个，防止过载
      }, 1000);
    }, 500);
  });

  // --- 缩放与拖拽逻辑 (保持之前的高清优化版本) ---
  function toggleZoom(el) {
    if (currentZoomed && currentZoomed !== el) return;
    if (!el.classList.contains('is-zoomed')) {
      currentZoomed = el;
      el.classList.add('is-zoomed');
      el.dataset.oriZ = el.style.zIndex;
      el.style.zIndex = 2000000;
      const rect = el.getBoundingClientRect();
      const moveX = (window.innerWidth / 2) - (rect.left + rect.width / 2);
      const moveY = (window.innerHeight / 2) - (rect.top + rect.height / 2);
      const scale = (window.innerHeight * 0.85) / rect.height;
      el.style.transform = `translate3d(${moveX}px, ${moveY}px, 0) scale(${scale})`;
      overlay.style.display = 'block';
      setTimeout(() => overlay.classList.add('active'), 10);
      overlay.onclick = el.onclick = () => toggleZoom(el);
    } else {
      el.classList.remove('is-zoomed');
      el.style.transform = 'translate3d(0,0,0) scale(1)';
      overlay.classList.remove('active');
      setTimeout(() => {
        overlay.style.display = 'none';
        el.style.zIndex = el.dataset.oriZ;
        currentZoomed = null;
        el.style.transform = '';
      }, 500);
    }
  }

  function bindWindowEvents(el) {
    const titleBar = el.querySelector(".title-bar");
    el.onmousedown = () => { if(!el.classList.contains('is-zoomed')) el.style.zIndex = zIndexCounter++; };
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    titleBar.onmousedown = (e) => {
      if(el.classList.contains('is-zoomed')) return;
      e.stopPropagation();
      pos3 = e.clientX; pos4 = e.clientY;
      document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
      document.onmousemove = (e) => {
        pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
        pos3 = e.clientX; pos4 = e.clientY;
        el.style.top = (el.offsetTop - pos2) + "px";
        el.style.left = (el.offsetLeft - pos1) + "px";
      };
    };
  }
</script>
</body>
</html>
